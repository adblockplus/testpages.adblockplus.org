default:
  image: registry.gitlab.com/eyeo/docker/adblockplus-ci:node16-no-python
  interruptible: true

stages:
  - build
  - test

variables:
  npm_config_audit: "false"
  npm_config_fund: "false"
  npm_config_prefer_offline: "true"

cache:
  - key:
      prefix: $CI_JOB_IMAGE
      files:
      - package-lock.json
    paths:
    - node_modules/
    - test/*-snapshots/download-cache/

build:
  stage: build
  before_script:
    # make and g++ required by node-gyp (abp2dnr dependency)
    - apt-get update && apt-get install -y make g++
    - npm install
  script:
    - npm run lint
    - npm run build -- --env release
    - DOCS_ERROR=$(npm run docs 2>&1 >/dev/null) && if [ ! -z "$DOCS_ERROR" ]; then echo $DOCS_ERROR && false; fi
    - npm run test-bundle
  artifacts:
    paths:
      - dist/
      - docs/
    exclude:
      - dist/package.json
    expire_in: 1 month

build:ABPUIExtension:
  stage: build
  image: node:12
  before_script:
    # enable unsafe-perm to avoid problems with running npm as root
    # see https://gitlab.com/eyeo/adblockplus/abpui/adblockplusui/-/issues/193
    - export npm_config_unsafe_perm=true
  script:
    # Update git version to fix problems with ls-files command
    # https://gitlab.com/eyeo/adblockplus/abpui/adblockplusui/-/issues/1040
    - echo "deb http://deb.debian.org/debian stretch-backports main" > /etc/apt/sources.list.d/stretch-backports.list
    - apt-get update
    - apt-get -t stretch-backports install -y git
    # Clone ABPUI
    - cd ..
    - git clone -b dep-ewe-2021-1 https://gitlab.com/eyeo/adblockplus/abpui/adblockplusui.git
    # Update dependencies
    - cd adblockplusui && npm run submodules:update
    - git submodule status
    # Checkout current commit  
    - cd vendor/webext-sdk/
    #Currently commit is hardcoded as gulpfile fails to build on current commit
    # git checkout $CI_COMMIT_SHA
    - git checkout e1f4204e786fcc0f59e9a201ae7b5c192b761c61
    - cd ..
    - cd ..
    - npm install
    # Create extension builds
    - cd adblockpluschrome
    - npx gulp build -t chrome --unhandled-rejections=strict
    - mv adblockpluschrome-*.zip adblockpluschrome.zip 
  artifacts:
    paths:
      - adblockplusui/adblockpluschrome/adblockplus-chrome.zip

.test:
  stage: test
  before_script:
    - apt-get update && apt-get install -y make g++
    - npm install
    - npm run test-server &
  needs:
    - job: build
      artifacts: true

test:v2:chromium:stable:
  extends: .test
  script:
    - xvfb-run -a npm test -- v2 chromium

test:v2:chromium:oldest:
  extends: .test
  script:
    - xvfb-run -a npm test -- v2 chromium 77.0.3865.0

test:v2:chromium:beta:
  extends: .test
  script:
    - xvfb-run -a npm test -- v2 chromium beta

test:v2:chromium:dev:
  extends: .test
  script:
    - xvfb-run -a npm test -- v2 chromium dev

test:v2:firefox:latest:
  extends: .test
  script:
    - npm test -- v2 firefox

test:v2:firefox:oldest:
  extends: .test
  script:
    - npm test -- v2 firefox 68.0
  # https://gitlab.com/eyeo/adblockplus/webext-sdk/-/issues/50
  retry: 2

test:v2:firefox:beta:
  extends: .test
  script:
    - npm test -- v2 firefox beta

test:v2:edge:windows:
  extends: .test
  variables:
    CI_PROJECT_ID_MAINSTREAM: 22365241
  before_script:
    - Invoke-WebRequest
        -Uri "${Env:CI_API_V4_URL}/projects/${Env:CI_PROJECT_ID_MAINSTREAM}/packages/generic/microsoft-edge/79.0.309/MicrosoftEdgeEnterpriseX64.msi"
        -Headers @{'JOB-TOKEN' = $Env:CI_JOB_TOKEN}
        -OutFile 'MicrosoftEdgeEnterpriseX64.msi'
    - Start-Process msiexec
        -ArgumentList "/i MicrosoftEdgeEnterpriseX64.msi /norestart /qn" -Wait
    # python2 is required by node-gyp (abp2dnr dependency)
    - choco install -y python2
    - choco upgrade -y nodejs --version 16.10.0
    - npm install
    - Start-Process "node" -ArgumentList "test/start-server.js" -PassThru
  script:
    - npm test -- v2 edge --timeout=15000
  tags:
    - shared-windows
    - windows
    - windows-1809
  cache: {}

test:v3:chromium:stable:
  extends: .test
  script:
    - xvfb-run -a npm test -- v3 chromium

test:v3:edge:linux:
  extends: .test
  before_script:
    - apt-get update && apt-get install -y make g++
    # https://www.how2shout.com/linux/install-microsoft-edge-on-linux/
    - wget https://packages.microsoft.com/keys/microsoft.asc
    - cat microsoft.asc | gpg --dearmor > microsoft.gpg
    - install -o root -g root -m 644 microsoft.gpg /etc/apt/trusted.gpg.d/
    - echo "deb [arch=amd64] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge-dev.list
    - rm microsoft.*
    - apt-get update && apt-get install -y microsoft-edge-stable
    - npm install
    - npm run test-server &
  script:
    - xvfb-run -a npm test -- v3 edge

test:testpages-integration:
  stage: test
  image: docker:19.03.5
  services:
    - docker:19.03.5-dind
  before_script:
    - docker info
    # enable unsafe-perm to avoid problems with running npm as root
    # see https://gitlab.com/eyeo/adblockplus/abpui/adblockplusui/-/issues/193
    - export npm_config_unsafe_perm=true
  dependencies:
    - build:ABPUIExtension

  variables:
    DOCKER_DRIVER: overlay2
  interruptible: true
  script:
    - docker build -t testpages --build-arg EXTENSION_FILE="adblockpluschrome.zip" .
    - docker run -shm-size=256m -e SKIP_EXTENSION_DOWNLOAD="true" -e BROWSER="Chromium \(latest\)" -e TESTS_EXCLUDE="Snippets" -it testpages 
